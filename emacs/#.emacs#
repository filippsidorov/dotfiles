
;; Основное 
(tool-bar-mode -1)
(scroll-bar-mode -1)


(setq inhibit-startup-screen t)
(setq inhibit-splash-screen t)

;; не спрашивать про симлинки на файлы под гитом
(setq vc-follow-symlinks t)



(if (equal system-type 'gnu/linux)
    (set-frame-font "Hack 14" nil t)
  (set-frame-font "Hack 18" nil t))


(setq-default fill-column 79) 
;;(add-hook 'text-mode-hook 'turn-on-auto-fill)
(add-hook 'org-mode-hook (lambda() (visual-line-mode t)))
(setq org-startup-truncated 1)



;; restclient
(use-package restclient
  :ensure t
  :mode (("\\.http\\'" . restclient-mode)
         ("\\.rest\\'" . restclient-mode))
  :config
  (setq restclient-same-buffer-response t)
  (setq restclient-same-buffer-response-name "*HTTP Response*"))



(use-package visual-fill-column
  :ensure t
  :hook (org-mode . visual-fill-column-mode))

;; show vertica ruler at 79 char
;; (add-hook 'org-mode-hook #'display-fill-column-indicator-mode)



;; gptel - LLM Integration for Emacs with Ollama
(use-package gptel
  :ensure t
  :bind (("C-c g" . gptel-send)
         ("C-c G" . gptel-menu))
  :custom
   (gptel-directives
   '((default . "You are a large language model living in Emacs and a helpful assistant. Respond concisely. Use org markup syntax where needed.")
     (programming . "You are a large language model and a careful programmer. Provide code and only code as output without any additional text, prompt or note.")
     ;; Add other custom directives here
     ))
  :config
  ;; Connect to local Ollama instance
  (setq gptel-model 'deepseek-v3.2:cloud 
        gptel-backend
        (gptel-make-ollama "Ollama"
          :host "localhost:11434"
          :stream t
          :models '(qwen2.5:7b
                    deepseek-v3.2:cloud
                    qwen3-coder:480b-cloud
                    qwen3:4b
                    qwen3-coder:30b
                    qwen2.5-coder:7b3
                    qwen2.5:3b
                    qwen3:14b))
        ;; Disable reasoning output by default
        gptel-include-reasoning nil
        ;; Org-mode: each heading is a separate conversation
        gptel-org-branching-context nil
        ;; Follow LLM output as it generates
        gptel-auto-scroll t))


  
  
  ;; Follow LLM output as it generates
(setq gptel-auto-scroll t)





(use-package llm
  :ensure t)

(use-package ellama
  :ensure t
  :after llm  ; Load after llm is available
  :config
  (require 'llm-ollama))


;; yasnippet
(use-package yasnippet
  :ensure t
  :config
  ;; Add your custom directory (defaults are automatically included)
  (add-to-list 'yas-snippet-dirs "~/.emacs.d/snippets")
  (yas-global-mode 1))


;; Dired
(use-package dired
  :ensure nil
  :custom
  (dired-listing-switches "-alh --group-directories-first"))



;; Backup
(setq backup-directory-alist '(("." . "~/Yandex.Disk/.org-backup")))
(setq make-backup-files t)
(setq auto-save-default t)

(define-key minibuffer-local-completion-map "\C-s" 
	    (lambda () (interactive) (insert " ")))


;; Hotkeys
(global-set-key "\C-cd" 'kill-whole-line)     
(global-set-key (kbd "C-c a") #'org-agenda)
(global-set-key (kbd "C-c k") #'calendar)


;; Markdown
(use-package markdown-mode
  :ensure t
  :mode ("README\\.md\\'" . gfm-mode)
  :init (setq markdown-command "multimarkdown")
  :bind (:map markdown-mode-map
              ("C-c C-e" . markdown-do)))

;; SQL
(require 'sql)
(defalias 'sql-get-login 'ignore)



;; Package archives
(require 'package)
(add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t)
(add-to-list 'package-archives '("melpa-stable" . "https://stable.melpa.org/packages/") t)
(package-initialize)




;; Completions
(defun my-sort-completions (completions)
  "Sort list of completions in alphanumeric order."
  (sort completions 'string-lessp))

(setq completions-sort 'my-sort-completions)
(setq completions-format "one-column")


;; Ido
(use-package ido
  :config
  (setq ido-enable-flex-matching t)
  (setq ido-everywhere t)
  (ido-mode 'both))



;; Org-mode
(use-package org
  :ensure t)

(use-package ox
  :after org)


(global-set-key (kbd "C-c c") 'org-capture)

(setq org-agenda-start-on-weekday 1)
(setq calendar-week-start-day 1)
(setq org-startup-truncated nil)
(setq org-agenda-skip-scheduled-if-done t)
(setq org-hide-emphasis-markers t)
(setq org-completion-use-ido t)
(setq org-id-link-to-org-use-id 'create-if-interactive)





(setq org-blank-before-new-entry '((heading . nil) (plain-list-item . nil)))

(setq org-todo-keywords
      '((sequence "TODO" "CHECK" "|" "DONE" "CANCEL")))

(setq org-todo-keyword-faces
      '(("NOTE" . "#8be9fd")
	("LINK" . "#f1fa8c")
	("WORK" . "#50fa7b")
	("SKIP" . "")))

(setq org-reverse-note-order t)

(setq org-refile-targets
      '(
	("~/Org/board-wb.org" :maxlevel . 2)
	("~/Org/daaa9e4c.org" :maxlevel . 1)
	("~/Org/para.org" :maxlevel . 3)
	("~/Org/threads.org" :maxlevel . 2)
        ("~/Org/3-resources.org" :maxlevel . 2)
	))

(defun my/sentence-case (str)
  "Convert STR to sentence case: capitalize first letter, lowercase the rest."
  (concat (upcase (substring str 0 1))
          (substring str 1)))


(setq org-capture-templates
     
      '(("t" "thread" entry (file+headline "~/Org/threads.org" "Threads")
	 "** %?"
	 :prepend t
	 )
	 ("d" "SDVG" plain (file "~/Org/sdvg.org")
          "- %?"
	  )	

	 ("w" "WB Backlog" entry (file+headline "~/Org/board-wb.org" "Backlog")
          "** %(my/sentence-case \"%i\") %?"
	  :prepend t
	  
	  )
	 ("s" "SQL" entry (file+headline "~/Org/sql.org" "SQL")
          "** %?"
	  :prepend t
	  )

	 ("q" "Ollama Question" entry (file+headline "~/Org/threads.org" "Now")
          "** Question: %?\n:PROPERTIES:\n:GPTEL_MODEL: deepseek-v3.2:cloud\n:GPTEL_BACKEND: Ollama\n:GPTEL_TOPIC: question-%<%Y-%m-%d-%H-%M>\n:END:\n\n"
	  :prepend t
	  )
	 	 
	 
	 
	 ("n" "WB Doing" entry (file+headline "~/Org/board-wb.org" "Doing")
          "** %(my/sentence-case \"%i\") %?"
	  :prepend t
	  )

	 ("p" "WB Ping" entry (file+headline "~/Org/board-wb.org" "Ping")
          "** %(my/sentence-case \"%i\") %?"
	  :prepend t
	  )

	 ("r" "Write or die" entry (file+headline "~/Org/wod.org" "WOD")
          "** %<%Y-%m-%d %H:%M> \n%?"
	  :prepend t
	  )

	("c" "Contact" entry (file "~/Org/network.org")
         "** %?")

	("m" "mn" entry (file "~/Org/0-inbox.org")
	 "** mn %<%Y/%m/%d> %?\nобсуждали:\n\nрешили:\n\ntodo:\n\n")))

(setq org-footnote-auto-adjust t)


(defface org-my-hash-tag-face
  '((t :foreground "#8be9fd"))
  "Face for custom org #tags.")

(defface org-my-people-tag-face
  '((t :foreground "#f1fa8c"))
  "Face for custom org @tags.")

(defun org-my--not-in-heading-p ()
  "Return t if point is not in an Org heading line."
  (save-excursion
    (beginning-of-line)
    (not (looking-at-p "\\*+\\s-"))))

(defun org-my--add-custom-font-lock ()
  (font-lock-add-keywords
   nil
   `(
     ;; #hashtag, but not at line-start if it's a heading
     ("\\([#][A-Za-zА-Яа-я0-9_-=]+\\)"
      (0 (when (org-my--not-in-heading-p)
           'org-my-hash-tag-face)
         prepend))
     ;; @person, but not at line-start if it's a heading
     ("\\([@][A-Za-zА-Яа-я0-9_-]+\\)"
      (0 (when (org-my--not-in-heading-p)
           'org-my-people-tag-face)
         prepend))
     )))

(add-hook 'org-mode-hook #'org-my--add-custom-font-lock)


;; Org-roam
(setq org-roam-dailies-directory "Dailies/")

(use-package org-roam
  :ensure t
  :custom
  (org-roam-completion-everywhere t)
  (org-roam-directory "~/Zettelkasten")
  (org-roam-mode-sections
      (list #'org-roam-backlinks-section
            #'org-roam-reflinks-section
            ))
  (org-roam-capture-templates
   '(("d" "default" plain "* ${title}\n%?"
      :target (file+head "%<%Y%m%d%H%M%S>_${slug}.org"
                         "#+title: ${title}\n#+date: %U\n#+filetags: %^G\n\n")
      :unnarrowed t)))
  (org-roam-dailies-capture-templates
   '(("d" "default" entry "* %?"
      :empty-lines 2
      :target (file+head "%<%Y-%m-%d>.org"
			 "#+title: %<%Y-%m-%d>\n#+STARTUP: show2levels\n"))
     ))  
  :bind (("C-c n l" . org-roam-buffer-toggle)
	 ("C-c n f" . org-roam-node-find)
	 ("C-c n i" . org-roam-node-insert)
	 ("C-c n r" . org-roam-node-random)
	 ("C-c n d c" . org-roam-dailies-capture-today)
	 ("C-c n d t" . org-roam-dailies-goto-today)
	 ("C-c n d d" . org-roam-dailies-goto-date)
	 ("C-c n d p" . org-roam-dailies-goto-previous-note)
	 ("C-c n d n" . org-roam-dailies-goto-next-note)
	 ("C-c n d b" . org-roam-buffer-display-dedicated)
	 :map org-mode-map
	 ("C-M-i" . completion-at-point))
  :config
  (org-roam-db-autosync-mode)
  )




(custom-set-variables
 ;; custom-set-variables was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 '(custom-safe-themes
   '("603a831e0f2e466480cdc633ba37a0b1ae3c3e9a4e90183833bc4def3421a961"
     "5a00018936fa1df1cd9d54bee02c8a64eafac941453ab48394e2ec2c498b834a"
     "2ce76d65a813fae8cfee5c207f46f2a256bac69dacbb096051a7a8651aa252b0"
     "99d1e29934b9e712651d29735dd8dcd431a651dfbe039df158aa973461af003e"
     "8d146df8bd640320d5ca94d2913392bc6f763d5bc2bb47bed8e14975017eea91"
     "e410458d3e769c33e0865971deb6e8422457fad02bf51f7862fa180ccc42c032"
     "9a977ddae55e0e91c09952e96d614ae0be69727ea78ca145beea1aae01ac78d2" default))
 '(dired-listing-switches "-ol")
 '(dracula-height-doc-title 1.215)
 '(dracula-height-title-1 1.138)
 '(dracula-height-title-2 1.067)
 '(org-agenda-files
   '("~/Org/3-resources.org" "/home/filippsidorov/Org/4-archives.org"
     "/home/filippsidorov/Org/2-areas.org"
     "/home/filippsidorov/Yandex.Disk/Org/1-projects.org"
     "/home/filippsidorov/Org/0-inbox.org"))
 '(package-selected-packages
   '(auctex dracula-theme ellama fontaine git-commit gptel ivy-bibtex
	    kaolin-themes logos magit markdown-mode modus-themes org-pomodoro
	    org-ref org-roam pomm restclient spacious-padding treemacs
	    visual-fill-column wc-mode yasnippet zotxt)))
(custom-set-faces
 ;; custom-set-faces was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 '(scroll-bar ((t (:background "#44475A" :foreground "#F8F8F2")))))


(add-to-list 'load-path "~/.emacs.d/org-hashtag-stats/")
(require 'org-hashtag-stats)



;; Themes
(load-theme 'dracula t)



;; Режим для экспорта фрагмента текста
;; TODO: добавить очистку лишних пробелов
(defun my-process-text-region (start end)
  (interactive "r")
  (let ((selected-text (buffer-substring-no-properties start end))
        (processed-text ""))
    
    (setq processed-text selected-text)
    (setq processed-text (replace-regexp-in-string "\n" " " processed-text))

    (with-current-buffer (get-buffer-create "*Processed Text*")
      (erase-buffer)
      (insert processed-text)
      (pop-to-buffer (current-buffer)))))



(define-minor-mode export-text-region-mode
  "Simple minor mode for processing selected text region."
  :init-value nil
  :lighter " xpReg"
  :keymap (let ((map (make-sparse-keymap)))
            (define-key map (kbd "C-c e t") #'my-process-text-region)
            map))

(provide 'export-text-region-mode)




